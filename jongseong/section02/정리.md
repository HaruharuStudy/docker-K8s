# 섹션02 - Docker 이미지 & 컨테이너: 코어 빌딩 블록

## 이미지와 컨테이너

- 이미지는 템플릿이다.
- 이미지는 코드와 코드를 실행하는데 필요한 도구를 포함한다.
- 컨테이너는 이미지의 실행 인스턴스

## 외부 이미지의 사용 & 실행

```bash
# 노드 이미지 다운로드
docker pull node:latest

# 노드 이미지 실행
doccker run node

# 실행중인 컨테이너 확인하기
docker ps -a

# 컨테이너 interactive 모드로 실행하기
docker run -it node
```

## 이미지 레이어 이해하기

1. 컨테이너 실행 동작
   - 컨테이너 실행 시 Dockerfile의 명령을 기반으로 이미지를 실행함.
   - Dockerfile에 지정된 마지막 명령이 실행되어 애플리케이션이 시작됨.

2. 레이어 구조
   - Docker 이미지는 여러 레이어로 구성됨.
   - Dockerfile의 각 명령은 별도의 레이어를 생성함.
   - 최종 레이어는 컨테이너 실행 시 활성화됨.

3. 이미지 캐싱 원리
   - Docker는 레이어별로 변경 여부를 확인함.
   - 변경되지 않은 레이어는 캐시에서 재사용됨.
   - 변경된 레이어 이후의 모든 레이어는 다시 생성됨.

4. 최적화 팁
   - 자주 변경되는 파일은 Dockerfile의 하단에 배치해 빌드 속도를 최적화할 수 있음.  
   - 종속성 설치와 같은 변경이 적은 명령은 상단에 배치해 캐시 재사용을 극대화할 수 있음.

## 이미지와 컨테이너 동작 방법 이해하기

- 컨테이너는 이미지에서 코드와 환경을 새 컨테이너로 복사하거나 새 파일로 복사하지 않는다.
- 컨테이너는 이미지에 저장된 환경을 사용한다. 이미지 위에 추가된 얇은 레이어일 뿐이다.

## 기본적인 도커 명령

```bash
docker ps -a  # 모든 컨테이너를 표시(중지되었거나, 실행 중인 컨테이너)

docker run # 이미지를 기반으로 새 컨테이너를 만들고 그 이후에 새 컨테이너가 시작
```

### attached mode vs detached mode

- attached mode: 컨테이너가 실행되면서 터미널을 차지하고 있음.
   - 우리가 그 컨테이너의 출력 결과를 수신한다는 것을 의미한다. 
- detached mode: 컨테이너가 실행되면서 터미널을 차지하지 않음
   - background에서 실행되는 것과 같은 효과
- `docker start` 는 detached mode가 기본값
- `docker run` 은 attached mode가 기본값
- detached mode로 실행했을 때 `docker attach` 를 통해 다시 연결할 수 있음
- 혹은 docker logs 를 통해 컨테이너의 출력된 로그를 확인할 수 있음(`-f` 옵션으로 계속 수신대기 할 수 있음)

### 인터렉티브 모드 & 터미널 모드

- `-i` : 인터렉티브 모드
- `-t` : 터미널 모드

```bash
docker build -f Dockerfile-rng -t section02-rng .

docker run -it section02-rng

# 또는 중지 시킨 뒤 아래의 명령을 실행해도 된다.
docker start -ai {컨테이너 이름}
```
 
### 필요없는 컨테이너 & 이미지 삭제하기

```bash
# 중지된 컨테이너 삭제
docker rm $(docker ps -aq -f "status=exited")

# 필요없는 이미지 삭제(실행하고 있는 컨테이너가 사용하는 이미지는 삭제 안됨)
docker image prune
```

- 강의에서 알려준 `--rm` 옵션은 개인적으로 개발환경에서만 써야 한다. 프로덕션 환경에서는 지양하는 것이 좋다.

## 이미지 검사하기

- docker inspect {이미지 ID}
- 환경변수, 포트, CMD 명령 등을 확인할 수 있다.
- 또한 레이어의 정보나 네트워크 정보 등도 확인 할 수 있다.ㅉ

## 복사하기

- `docker cp {소스경로} {복사 타겟 경로}`
- `docker cp {호스트 경로} {컨테이너 이름}:{타겟 컨테이너 경로}` 호스트 머신의 파일을 컨테이너로 복사
- `docker cp  {컨테이너 이름}:{컨테이너 경로} {호스트 경로}` 컨테이너의 파일을 호스트 머신으로 복사

## 이름 지정하기

- `--name` 옵션을 사용하여 컨테이너 이름을 지정할 수 있다.
- 이미지 태그도 지정할 수 있음 `-t {이미지 이름}:{태그}`

```bash
docker build -t goals:latest .
```